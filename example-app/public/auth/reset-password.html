<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinitialiser le mot de passe - Laravel Passport Auth</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Laravel Passport Auth</h1>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> Accueil
                </a>
                <a href="register.html" class="nav-link">
                    <i class="fas fa-user-plus"></i> Inscription
                </a>
                <a href="login.html" class="nav-link">
                    <i class="fas fa-sign-in-alt"></i> Connexion
                </a>
                <a href="profile.html" class="nav-link">
                    <i class="fas fa-user"></i> Profil
                </a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="form-container">
                <div class="form-header">
                    <h2>
                        <i class="fas fa-lock"></i>
                        Nouveau mot de passe
                    </h2>
                    <p>Créez un nouveau mot de passe sécurisé pour votre compte</p>
                </div>

                <!-- Token Verification Status -->
                <div id="tokenStatus" class="token-status">
                    <div class="status-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Vérification du lien de réinitialisation...</span>
                    </div>
                </div>

                <!-- Reset Form -->
                <div id="resetFormContainer" class="reset-form-container" style="display: none;">
                    <div class="security-info">
                        <div class="security-icon">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <div class="security-content">
                            <h3>Lien vérifié avec succès</h3>
                            <p>Vous pouvez maintenant créer votre nouveau mot de passe</p>
                            <div class="user-info">
                                <i class="fas fa-user"></i>
                                <span>Compte: <strong id="userEmail">-</strong></span>
                            </div>
                        </div>
                    </div>

                    <form id="resetPasswordForm" class="auth-form">
                        <input type="hidden" id="resetToken" name="token">
                        <input type="hidden" id="resetEmail" name="email">

                        <div class="form-group">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock"></i> Nouveau mot de passe
                            </label>
                            <div class="password-input-container">
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password" 
                                    class="form-input" 
                                    placeholder="Votre nouveau mot de passe"
                                    required
                                >
                                <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password_confirmation" class="form-label">
                                <i class="fas fa-lock"></i> Confirmer le mot de passe
                            </label>
                            <div class="password-input-container">
                                <input 
                                    type="password" 
                                    id="password_confirmation" 
                                    name="password_confirmation" 
                                    class="form-input" 
                                    placeholder="Confirmez votre nouveau mot de passe"
                                    required
                                >
                                <button type="button" class="password-toggle" onclick="togglePassword('password_confirmation')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div id="passwordStrength" class="password-strength">
                            <div class="strength-label">Force du mot de passe:</div>
                            <div class="strength-container"></div>
                        </div>

                        <!-- Password Requirements -->
                        <div class="password-requirements">
                            <h4><i class="fas fa-info-circle"></i> Exigences du mot de passe:</h4>
                            <ul class="requirements-list">
                                <li id="req-length" class="requirement">
                                    <i class="fas fa-times"></i> Au moins 8 caractères
                                </li>
                                <li id="req-uppercase" class="requirement">
                                    <i class="fas fa-times"></i> Une lettre majuscule
                                </li>
                                <li id="req-lowercase" class="requirement">
                                    <i class="fas fa-times"></i> Une lettre minuscule
                                </li>
                                <li id="req-number" class="requirement">
                                    <i class="fas fa-times"></i> Un chiffre
                                </li>
                                <li id="req-special" class="requirement">
                                    <i class="fas fa-times"></i> Un caractère spécial
                                </li>
                            </ul>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="resetBtn" class="btn btn-primary btn-full">
                                <i class="fas fa-save"></i>
                                Réinitialiser le mot de passe
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Error State -->
                <div id="tokenError" class="token-error" style="display: none;">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Lien invalide ou expiré</h3>
                    <p id="errorMessage">Ce lien de réinitialisation n'est plus valide.</p>
                    <div class="error-actions">
                        <a href="forgot-password.html" class="btn btn-primary">
                            <i class="fas fa-redo"></i> Demander un nouveau lien
                        </a>
                        <a href="login.html" class="btn btn-secondary">
                            <i class="fas fa-sign-in-alt"></i> Retour à la connexion
                        </a>
                    </div>
                </div>

                <!-- Success State -->
                <div id="resetSuccess" class="reset-success" style="display: none;">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Mot de passe réinitialisé avec succès !</h3>
                    <p>Votre nouveau mot de passe a été enregistré. Vous pouvez maintenant vous connecter.</p>
                    <div class="success-actions">
                        <a href="login.html" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Se connecter maintenant
                        </a>
                    </div>
                </div>

                <!-- Response Display -->
                <div id="responseContainer" class="response-container" style="display: none;">
                    <div class="response-header">
                        <h4><i class="fas fa-server"></i> Réponse de l'API</h4>
                    </div>
                    <pre id="responseContent"></pre>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="security-tips">
                <div class="tips-card">
                    <h3><i class="fas fa-lightbulb"></i> Conseils de sécurité</h3>
                    <div class="tips-list">
                        <div class="tip-item">
                            <i class="fas fa-key"></i>
                            <span>Utilisez un mot de passe unique pour ce compte</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-random"></i>
                            <span>Mélangez lettres, chiffres et symboles</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-eye-slash"></i>
                            <span>Ne partagez jamais votre mot de passe</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Activez l'authentification à deux facteurs si disponible</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Laravel Passport Auth Interface. Réinitialisation sécurisée de mot de passe.</p>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        let resetToken = '';
        let resetEmail = '';

        document.addEventListener('DOMContentLoaded', function() {
            initializeResetPassword();
            extractTokenFromUrl();
        });

        function initializeResetPassword() {
            const form = document.getElementById('resetPasswordForm');
            form.addEventListener('submit', handleResetPasswordSubmit);

            // Écouter les changements de mot de passe pour la validation
            const passwordInput = document.getElementById('password');
            passwordInput.addEventListener('input', validatePasswordStrength);
        }

        function extractTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            resetToken = urlParams.get('token');
            resetEmail = urlParams.get('email');

            if (!resetToken || !resetEmail) {
                showTokenError('Lien de réinitialisation invalide. Paramètres manquants.');
                return;
            }

            // Vérifier la validité du token
            verifyResetToken();
        }

        // Méthode de fallback pour vérifier le token
        async function verifyPasswordResetTokenFallback(token, email) {
            const response = await fetch('http://localhost:8000/api/auth/password/verify-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ token, email })
            });

            const data = await response.json();

            return {
                success: response.ok,
                status: response.status,
                data: data
            };
        }

        // Méthode de fallback pour réinitialiser le mot de passe
        async function resetPasswordFallback(resetData) {
            const response = await fetch('http://localhost:8000/api/auth/password/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(resetData)
            });

            const data = await response.json();

            return {
                success: response.ok,
                status: response.status,
                data: data
            };
        }

        async function verifyResetToken() {
            try {
                // Utiliser directement le fallback
                console.log('Utilisation du fallback verifyPasswordResetTokenFallback');
                let result = await verifyPasswordResetTokenFallback(resetToken, resetEmail);
                
                if (result.success) {
                    showResetForm();
                } else {
                    showTokenError(result.data?.message || 'Token invalide ou expiré');
                }
            } catch (error) {
                showTokenError(`Erreur de vérification: ${error.message}`);
            }
        }

        function showResetForm() {
            document.getElementById('tokenStatus').style.display = 'none';
            document.getElementById('resetFormContainer').style.display = 'block';
            document.getElementById('userEmail').textContent = resetEmail;
            document.getElementById('resetToken').value = resetToken;
            document.getElementById('resetEmail').value = resetEmail;
        }

        function showTokenError(message) {
            document.getElementById('tokenStatus').style.display = 'none';
            document.getElementById('tokenError').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function showResetSuccess() {
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'block';
        }

        async function handleResetPasswordSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('resetBtn');
            const form = event.target;
            
            // Nettoyer les erreurs précédentes
            FormManager.clearAllErrors(form);
            
            // Récupérer les données du formulaire
            const formData = new FormData(form);
            const resetData = Object.fromEntries(formData.entries());
            
            // Validation côté client
            if (!validateResetForm(resetData)) {
                return;
            }
            
            try {
                LoadingManager.show(submitBtn, 'Réinitialisation...');
                
                // Utiliser directement le fallback
                console.log('Utilisation du fallback resetPasswordFallback');
                let result = await resetPasswordFallback(resetData);
                
                displayResponse(result);
                
                if (result.success) {
                    NotificationManager.show('Mot de passe réinitialisé avec succès !', 'success');
                    showResetSuccess();
                } else {
                    NotificationManager.show(
                        result.data?.message || 'Erreur lors de la réinitialisation', 
                        'error'
                    );
                    
                    // Afficher les erreurs de validation
                    if (result.data?.errors) {
                        Object.keys(result.data.errors).forEach(field => {
                            FormManager.showFieldError(field, result.data.errors[field][0]);
                        });
                    }
                }
            } catch (error) {
                NotificationManager.show(`Erreur: ${error.message}`, 'error');
                displayResponse({ success: false, error: error.message });
            } finally {
                LoadingManager.hide(submitBtn);
            }
        }

        function validateResetForm(data) {
            let isValid = true;
            
            // Validation du mot de passe
            if (!FormManager.validateRequired(data.password)) {
                FormManager.showFieldError('password', 'Le mot de passe est requis');
                isValid = false;
            } else if (data.password.length < 8) {
                FormManager.showFieldError('password', 'Le mot de passe doit contenir au moins 8 caractères');
                isValid = false;
            }
            
            // Validation de la confirmation
            if (!FormManager.validateRequired(data.password_confirmation)) {
                FormManager.showFieldError('password_confirmation', 'La confirmation est requise');
                isValid = false;
            } else if (data.password !== data.password_confirmation) {
                FormManager.showFieldError('password_confirmation', 'Les mots de passe ne correspondent pas');
                isValid = false;
            }
            
            return isValid;
        }

        function validatePasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthContainer = document.querySelector('.strength-container');
            
            // Critères de validation
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            // Mettre à jour les indicateurs visuels
            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(`req-${req}`);
                const icon = element.querySelector('i');
                
                if (requirements[req]) {
                    element.classList.add('valid');
                    icon.className = 'fas fa-check';
                } else {
                    element.classList.remove('valid');
                    icon.className = 'fas fa-times';
                }
            });
            
            // Calculer la force
            const validCount = Object.values(requirements).filter(Boolean).length;
            const strength = Math.min(validCount, 5);
            
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#16a34a'];
            const levels = ['Très faible', 'Faible', 'Moyen', 'Fort', 'Très fort'];
            
            strengthContainer.innerHTML = `
                <div class="strength-bar">
                    <div class="strength-fill" style="width: ${(strength / 5) * 100}%; background: ${colors[strength - 1] || colors[0]}"></div>
                </div>
                <div class="strength-text" style="color: ${colors[strength - 1] || colors[0]}">
                    ${levels[strength - 1] || levels[0]}
                </div>
            `;
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentNode.querySelector('.password-toggle i');
            
            if (field.type === 'password') {
                field.type = 'text';
                button.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                button.className = 'fas fa-eye';
            }
        }

        function displayResponse(result) {
            const container = document.getElementById('responseContainer');
            const content = document.getElementById('responseContent');
            
            container.style.display = 'block';
            container.className = `response-container ${result.success ? 'response-success' : 'response-error'}`;
            content.textContent = JSON.stringify(result.data || result, null, 2);
        }
    </script>
</body>
</html>
